name: Sector Trend Analysis

on:
  schedule:
    # 毎日 UTC 06:40 (JST 15:40) に1回だけ実行
    # 変更: 末尾を '*' から '1-5' にし、土日を除外 (月〜金のみトリガー)
    - cron: '40 6 * * 1-5'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # 変更: 祝日判定用ライブラリを追加
          pip install jpholiday

      - name: Run sector analysis
        # GCP認証情報は不要になったため削除
        # 変更: 祝日なら実行せずスキップする判定を追加
        run: |
          python -c "import jpholiday, datetime, sys; JST=datetime.timezone(datetime.timedelta(hours=9)); sys.exit(1) if jpholiday.is_holiday(datetime.datetime.now(JST)) else sys.exit(0)" && python sector_analysis.py || echo "Holiday skip: sector_analysis"

      - name: Run WordPress Publisher
        env:
          # GCP情報は不要のため削除
          # WordPress情報のみ渡す
          TOFU_WORDPRESS: ${{ secrets.TOFU_WORDPRESS }}
        # 変更: 分析同様、祝日なら投稿処理もスキップする判定を追加
        run: |
          python -c "import jpholiday, datetime, sys; JST=datetime.timezone(datetime.timedelta(hours=9)); sys.exit(1) if jpholiday.is_holiday(datetime.datetime.now(JST)) else sys.exit(0)" && python wordpress_publisher.py || echo "Holiday skip: wordpress_publisher"

      - name: Prevent 60-day workflow suspension
        run: |
          last_commit_time=$(git log -1 --format=%ct)
          current_time=$(date +%s)
          diff_days=$(( (current_time - last_commit_time) / 86400 ))
          
          echo "最終更新から ${diff_days} 日経過しています。"
          
          if [ "$diff_days" -ge 50 ]; then
            echo "50日以上経過しているため、ワークフロー停止回避の空コミットを作成します。"
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git commit --allow-empty -m "chore: keep alive to prevent workflow suspension"
            git push
          else
            echo "空コミットは不要です。"
          fi
